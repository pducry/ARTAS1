<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="ARTASAS - Immersive image gallery experience">
  <meta name="theme-color" content="#0a0a0f">
  <title>ARTASAS</title>
  <link rel="icon" type="image/png" href="FAVICON.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root { --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    
    html, body {
      height: 100%;
      overflow: hidden;
      background: #000;
      color: #e0e0e0;
      font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      cursor: grab;
      user-select: none;
      -webkit-user-select: none;
    }
    
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: 
        radial-gradient(1px 1px at 20px 30px, rgba(255,255,255,0.3), transparent),
        radial-gradient(1px 1px at 40px 70px, rgba(255,255,255,0.2), transparent),
        radial-gradient(1px 1px at 50px 160px, rgba(255,255,255,0.3), transparent);
      background-repeat: repeat;
      background-size: 200px 200px;
      pointer-events: none;
      opacity: 0.6;
    }
    
    body:active { cursor: grabbing; }

    .logo { position: fixed; top: 24px; left: 50%; transform: translateX(-50%); z-index: 100; }
    .logo a { display: block; pointer-events: auto; }
    .logo img { height: 21px; width: auto; opacity: 0.7; transition: opacity 0.2s ease; }
    .logo a:hover img { opacity: 1; }

    .auth-links {
      position: fixed;
      top: 24px;
      right: 40px;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .auth-link {
      color: rgba(255, 255, 255, 0.5);
      font-size: 13px;
      font-weight: 400;
      text-decoration: none;
      letter-spacing: 0.02em;
      transition: color 0.2s ease;
    }

    .auth-link:hover { color: #fff; }


    #gallery-container { position: fixed; inset: 0; overflow: hidden; background: #000; }
    #gallery-canvas { position: fixed; inset: 0; pointer-events: none; }
    
    .gallery-item {
      position: fixed;
      cursor: pointer;
      border-radius: 6px;
      overflow: hidden;
      background: #0a0a0a;
      pointer-events: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      will-change: left, top, width, height, opacity;
    }
    
    .gallery-item img { display: block; width: 100%; height: 100%; object-fit: cover; pointer-events: none; -webkit-user-drag: none; }
    
    .gallery-save-btn {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 5px 8px;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s, background 0.2s;
      z-index: 10;
    }
    
    .gallery-item:hover .gallery-save-btn { opacity: 1; }
    .gallery-save-btn:hover { background: rgba(0, 0, 0, 0.8); }
    
    .gallery-save-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      min-width: 160px;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      padding: 6px 0;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-4px);
      transition: all 0.2s;
      z-index: 20;
    }
    
    .gallery-save-btn:hover .gallery-save-dropdown { opacity: 1; visibility: visible; transform: translateY(0); }
    
    .gallery-save-dropdown-item {
      display: block;
      width: 100%;
      padding: 8px 14px;
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      text-align: left;
      cursor: pointer;
      transition: background 0.15s;
    }
    
    .gallery-save-dropdown-item:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }

    /* Image Detail */
    .image-detail {
      position: fixed;
      inset: 0;
      z-index: 200;
      background: #000;
      display: flex;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.4s ease, visibility 0.4s ease;
    }
    
    .image-detail.active { opacity: 1; visibility: visible; }
    
    .detail-close {
      position: fixed;
      top: 24px;
      left: 24px;
      z-index: 210;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 18px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 30px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .detail-close:hover { background: rgba(255, 255, 255, 0.12); color: #fff; }
    
    .detail-image-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 100px;
      position: relative;
      min-height: 100vh;
    }
    
    .detail-image-container {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      max-width: calc(100% - 100px);
      perspective: 1000px;
    }
    
    .detail-image {
      display: block;
      max-width: 100%;
      max-height: 85vh;
      width: auto;
      height: auto;
      object-fit: contain;
      border-radius: 12px;
      box-shadow: 0 40px 120px rgba(0, 0, 0, 0.6);
      margin: auto;
      transition: transform 0.1s ease-out, box-shadow 0.3s ease;
      transform-style: preserve-3d;
    }
    
    .detail-image:hover { box-shadow: 0 50px 140px rgba(0, 0, 0, 0.7); }
    .detail-image.dragging { opacity: 0.7; cursor: grabbing; }
    
    .nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      color: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
    }
    
    .nav-arrow:hover { border-color: rgba(255, 255, 255, 0.5); color: rgba(255, 255, 255, 0.9); background: rgba(255, 255, 255, 0.05); }
    .nav-arrow svg { width: 20px; height: 20px; }
    .nav-arrow-left { left: 24px; }
    .nav-arrow-right { right: 24px; }
    
    .image-counter { position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); font-size: 11px; color: rgba(255, 255, 255, 0.35); letter-spacing: 0.15em; }

    /* Sidebar */
    .detail-sidebar {
      width: 320px;
      height: 100vh;
      overflow-y: auto;
      padding: 80px 30px 40px;
      background: rgba(255, 255, 255, 0.02);
      border-left: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      flex-direction: column;
      gap: 32px;
    }
    
    .section-title { font-size: 10px; text-transform: uppercase; letter-spacing: 0.2em; color: rgba(255, 255, 255, 0.35); }

    .color-palette { display: flex; flex-direction: column; gap: 14px; }
    .color-swatches { display: flex; flex-wrap: wrap; gap: 8px; }
    
    .color-swatch {
      position: relative;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      transition: transform 0.2s ease;
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    
    .color-swatch:hover { transform: scale(1.2); z-index: 10; }
    
    .color-hex {
      position: absolute;
      bottom: -26px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      font-family: 'SF Mono', Monaco, monospace;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.7);
      padding: 3px 6px;
      border-radius: 3px;
      pointer-events: none;
      z-index: 100;
    }
    
    .color-swatch:hover .color-hex { opacity: 1; visibility: visible; }
    .color-hex.copied { background: rgba(255, 255, 255, 0.15); color: rgba(255, 255, 255, 0.9); }

    .detail-description { display: flex; flex-direction: column; gap: 12px; }
    .detail-description-text { font-size: 13px; line-height: 1.7; color: rgba(255, 255, 255, 0.65); }
    .detail-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .detail-tag { padding: 5px 10px; background: rgba(255, 255, 255, 0.05); border-radius: 14px; font-size: 11px; color: rgba(255, 255, 255, 0.45); }

    .save-board-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 10px 18px;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 6px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      letter-spacing: 0.05em;
      cursor: default;
    }
    
    .save-board-btn.saved { border-color: rgba(255, 255, 255, 0.6); color: rgba(255, 255, 255, 0.9); }
    .save-board-btn svg { width: 16px; height: 16px; }

    .saved-by { display: flex; flex-direction: column; gap: 12px; }
    .saved-by-users { display: flex; flex-wrap: wrap; gap: 8px; }
    
    .saved-user { display: flex; align-items: center; gap: 8px; padding: 6px 10px; background: transparent; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 22px; }
    .saved-user-link { text-decoration: none; cursor: pointer; transition: all 0.2s ease; }
    .saved-user-link:hover { border-color: rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.05); }
    .saved-user-avatar { width: 22px; height: 22px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); }
    .saved-user-name { font-size: 11px; color: rgba(255, 255, 255, 0.6); }
    .saved-count { display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; background: rgba(255, 255, 255, 0.06); border-radius: 50%; font-size: 10px; color: rgba(255, 255, 255, 0.45); }

    #color-canvas { display: none; }

    /* Drag to Board Overlay */
    .drag-boards-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .drag-boards-overlay.active { opacity: 1; visibility: visible; }
    .drag-boards-container { display: flex; gap: 24px; flex-wrap: wrap; justify-content: center; max-width: 800px; padding: 40px; }
    
    .drag-board-target {
      width: 160px;
      height: 100px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.02);
    }
    
    .drag-board-target:hover, .drag-board-target.hover { border-color: rgba(255, 255, 255, 0.4); background: rgba(255, 255, 255, 0.06); }
    .drag-board-target.drop-success { border-color: rgba(255, 255, 255, 0.6); background: rgba(255, 255, 255, 0.1); }
    .drag-board-name { font-size: 13px; font-weight: 500; color: rgba(255, 255, 255, 0.7); }
    .drag-board-count { font-size: 10px; color: rgba(255, 255, 255, 0.35); }
    .drag-hint { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); font-size: 11px; color: rgba(255, 255, 255, 0.35); z-index: 1001; opacity: 0; transition: opacity 0.3s; }
    .drag-boards-overlay.active .drag-hint { opacity: 1; }
    .drag-preview { position: fixed; pointer-events: none; z-index: 1002; opacity: 0.9; border-radius: 8px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); display: none; }

    /* Controls */
    .controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      max-width: calc(100vw - 48px);
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .controls-help { font-size: 11px; font-weight: 400; color: rgba(255, 255, 255, 0.35); letter-spacing: 0.02em; white-space: nowrap; }
    .controls-help span { margin: 0 8px; color: rgba(255, 255, 255, 0.2); }
    
    
    .custom-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      color: rgba(255, 255, 255, 0.5);
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all var(--transition);
    }
    
    .custom-toggle:hover { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.15); color: rgba(255, 255, 255, 0.8); }
    .custom-toggle.active { background: rgba(255, 255, 255, 0.12); color: rgba(255, 255, 255, 0.9); }
    
    .custom-icon { display: flex; gap: 3px; align-items: center; }
    .custom-icon span { width: 3px; height: 10px; background: currentColor; border-radius: 1px; opacity: 0.8; }
    .custom-icon span:nth-child(2) { height: 14px; }
    .custom-icon span:nth-child(3) { height: 6px; }
    
    .main-customization {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 8px 14px;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
    }
    
    .custom-group { display: flex; align-items: center; gap: 10px; }
    .custom-label { font-size: 10px; color: rgba(255, 255, 255, 0.4); text-transform: uppercase; letter-spacing: 0.1em; white-space: nowrap; }
    .custom-slider { width: 80px; height: 4px; -webkit-appearance: none; background: rgba(255, 255, 255, 0.1); border-radius: 2px; cursor: pointer; }
    .custom-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: rgba(255, 255, 255, 0.8); cursor: pointer; }
    .custom-divider { width: 1px; height: 16px; background: rgba(255, 255, 255, 0.1); }
    
    .grid-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      color: rgba(255, 255, 255, 0.5);
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all var(--transition);
    }
    
    .grid-toggle:hover { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.15); color: rgba(255, 255, 255, 0.8); }
    .grid-toggle.active { background: rgba(255, 255, 255, 0.12); color: rgba(255, 255, 255, 0.9); }
    
    .grid-icon { display: grid; grid-template-columns: repeat(2, 5px); gap: 2px; }
    .grid-icon span { width: 5px; height: 5px; background: currentColor; border-radius: 1px; opacity: 0.8; }
    
    .zoom-indicator { position: fixed; bottom: 20px; right: 24px; z-index: 100; font-size: 10px; color: rgba(255, 255, 255, 0.3); font-variant-numeric: tabular-nums; letter-spacing: 0.05em; }

    .view-switcher {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 3px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
    }

    .view-mode-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      color: rgba(255, 255, 255, 0.4);
      font-size: 10px;
      font-weight: 500;
      font-family: inherit;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .view-mode-btn svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .view-mode-btn:hover {
      color: rgba(255, 255, 255, 0.7);
      background: rgba(255, 255, 255, 0.06);
    }

    .view-mode-btn.active {
      color: rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.12);
    }

    /* Grid View */
    .grid-view {
      position: fixed;
      inset: 0;
      z-index: 150;
      background: #000;
      padding: 80px 32px 100px;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition), visibility var(--transition);
    }
    
    .grid-view.active { opacity: 1; visibility: visible; }
    
    .grid-close {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 160;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 6px;
      color: rgba(255, 255, 255, 0.6);
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all 0.2s ease;
      opacity: 0;
      visibility: hidden;
    }
    
    .grid-close.active { opacity: 1; visibility: visible; }
    .grid-close:hover { background: rgba(255, 255, 255, 0.15); color: rgba(255, 255, 255, 0.9); }
    .grid-close svg { width: 16px; height: 16px; }
    
    .grid-view-content {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      max-width: 1800px;
      margin: 0 auto;
    }
    
    .grid-view-content.layout-1 { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    .grid-view-content.layout-1 .grid-view-item { aspect-ratio: 1; }
    
    .grid-view-content.layout-2 { grid-template-columns: repeat(4, 1fr); }
    .grid-view-content.layout-2 .grid-view-item { aspect-ratio: 1; }
    .grid-view-content.layout-2 .grid-view-item:nth-child(5n+1) { grid-column: span 2; grid-row: span 2; }
    
    .grid-view-content.layout-3 { grid-template-columns: repeat(5, 1fr); }
    .grid-view-content.layout-3 .grid-view-item { aspect-ratio: 1; }
    .grid-view-content.layout-3 .grid-view-item:nth-child(6n+1) { grid-column: span 2; aspect-ratio: 2/1; }
    .grid-view-content.layout-3 .grid-view-item:nth-child(8n+4) { grid-row: span 2; aspect-ratio: 1/2; }
    
    .grid-view-content.layout-4 { grid-template-columns: repeat(3, 1fr); grid-auto-rows: 200px; }
    .grid-view-content.layout-4 .grid-view-item { aspect-ratio: auto; }
    .grid-view-content.layout-4 .grid-view-item:nth-child(4n+1) { grid-column: span 2; grid-row: span 2; }
    
    .grid-view-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 4px;
      overflow: visible;
      cursor: pointer;
      background: #111;
    }
    
    .grid-view-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
    
    .grid-save-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 6px 10px;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 4px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
    }
    
    .grid-view-item:hover .grid-save-btn { opacity: 1; }
    
    .save-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      min-width: 160px;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      padding: 6px 0;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-4px);
      transition: all 0.2s;
      z-index: 20;
    }
    
    .grid-save-btn:hover .save-dropdown { opacity: 1; visibility: visible; transform: translateY(0); }
    
    .save-dropdown-item {
      display: block;
      width: 100%;
      padding: 7px 12px;
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 11px;
      text-align: left;
      cursor: pointer;
    }
    
    .save-dropdown-item:hover { background: rgba(255, 255, 255, 0.1); }

    /* Grid Customization */
    .grid-customization {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 160;
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 8px 16px;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .grid-customization.active { opacity: 1; visibility: visible; }
    
    .layout-switcher { display: flex; gap: 4px; }
    
    .layout-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background: transparent;
      border: none;
      border-radius: 4px;
      color: rgba(255, 255, 255, 0.35);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .layout-btn:hover { color: rgba(255, 255, 255, 0.6); }
    .layout-btn.active { color: rgba(255, 255, 255, 0.9); background: rgba(255, 255, 255, 0.1); }

    /* Loading */
    .loading {
      position: fixed;
      inset: 0;
      z-index: 300;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      transition: opacity 0.6s ease;
    }
    
    .loading.hidden { opacity: 0; pointer-events: none; }
    
    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid rgba(255, 255, 255, 0.06);
      border-top-color: rgba(255, 255, 255, 0.4);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 900px) {
      .image-detail { flex-direction: column; }
      .detail-image-area { padding: 80px 60px 40px; min-height: auto; }
      .detail-image-container { max-width: 100%; }
      .detail-image { max-height: 50vh; }
      .nav-arrow-left { left: 10px; }
      .nav-arrow-right { right: 10px; }
      .detail-sidebar { width: 100%; height: auto; border-left: none; border-top: 1px solid rgba(255, 255, 255, 0.06); padding: 30px 20px; }
    }
    
    @media (max-width: 768px) {
      .controls-help { display: none; }
      .custom-toggle { display: none !important; }
      #custom-row { display: none !important; }
      .home-switcher { display: none; }
      .grid-view { padding: 70px 16px 16px; }
      .grid-view-content, .grid-view-content.layout-1, .grid-view-content.layout-2, .grid-view-content.layout-3, .grid-view-content.layout-4 { 
        grid-template-columns: repeat(2, 1fr); gap: 8px; 
      }
      .grid-view-content .grid-view-item { grid-column: auto !important; grid-row: auto !important; aspect-ratio: 1 !important; }
      .grid-customization { display: none; }
    }
  </style>
</head>
<body>
  <div class="loading" id="loading"><div class="loading-spinner"></div></div>
  
  <div class="logo"><a href="index.html"><img src="logo2.png" alt="ARTASAS"></a></div>
  
  <div class="auth-links">
    <a href="home_logada.html" class="auth-link">Log in</a>
    <a href="home_logada.html" class="auth-link">Sign up</a>
  </div>

  
  <div id="gallery-container"><div id="gallery-canvas"></div></div>
  <canvas id="vortex-lines" style="position:fixed;inset:0;z-index:1;pointer-events:none;display:none;"></canvas>
  
  <div class="image-detail" id="image-detail">
    <button class="detail-close" id="detail-close">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
      Back
    </button>
    
    <div class="detail-image-area">
      <button class="nav-arrow nav-arrow-left" id="nav-prev">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
      </button>
      
      <div class="detail-image-container">
        <img class="detail-image" id="detail-image" src="" alt="">
      </div>
      
      <button class="nav-arrow nav-arrow-right" id="nav-next">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
      </button>
      
      <div class="image-counter" id="image-counter">1 / 42</div>
    </div>
    
    <div class="detail-sidebar">
      <div class="color-palette">
        <div class="section-title">Colors</div>
        <div class="color-swatches" id="color-swatches"></div>
      </div>
      
      <div class="detail-description">
        <div class="section-title">About</div>
        <p class="detail-description-text">A stunning visual composition exploring the interplay of light, shadow, and form.</p>
        <div class="detail-tags">
          <span class="detail-tag">artasas</span>
          <span class="detail-tag">digital art</span>
          <span class="detail-tag">creative</span>
        </div>
      </div>
      
      <div>
        <button class="save-board-btn" id="save-board-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
          Save to Board
        </button>
      </div>
      
      <div class="saved-by">
        <div class="section-title">Also saved by</div>
        <div class="saved-by-users">
          <a href="profile-jaimesiux.html" class="saved-user saved-user-link"><img class="saved-user-avatar" src="https://i.pravatar.cc/44?img=1" alt=""><span class="saved-user-name">@jaimesiux</span></a>
          <a href="profile.html" class="saved-user saved-user-link"><img class="saved-user-avatar" src="https://i.pravatar.cc/44?img=3" alt=""><span class="saved-user-name">@alex</span></a>
          <a href="profile-pame.html" class="saved-user saved-user-link"><img class="saved-user-avatar" src="https://i.pravatar.cc/44?img=5" alt=""><span class="saved-user-name">@pame</span></a>
          <div class="saved-count">+12</div>
        </div>
      </div>
    </div>
  </div>
  
  <canvas id="color-canvas"></canvas>
  
  <!-- Drag to Board Overlay -->
  <div class="drag-boards-overlay" id="drag-boards-overlay">
    <div class="drag-boards-container" id="drag-boards-container"></div>
    <div class="drag-hint">Drop on a board to save</div>
  </div>
  <img class="drag-preview" id="drag-preview" src="" alt="">
  
  <div class="grid-view" id="grid-view">
    <div class="grid-view-content" id="grid-content"></div>
  </div>
  
  <button class="grid-close" id="grid-close">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
    CLOSE
  </button>
  
  <div class="grid-customization" id="grid-customization">
    <div class="custom-group">
      <span class="custom-label">Gap</span>
      <input type="range" class="custom-slider" id="gap-slider" min="4" max="40" value="12">
    </div>
    <div class="custom-divider"></div>
    <div class="custom-group">
      <span class="custom-label">Size</span>
      <input type="range" class="custom-slider" id="size-slider" min="150" max="350" value="220">
    </div>
    <div class="custom-divider"></div>
    <div class="layout-switcher" id="layout-switcher">
      <button class="layout-btn active" data-layout="1">1</button>
      <button class="layout-btn" data-layout="2">2</button>
      <button class="layout-btn" data-layout="3">3</button>
      <button class="layout-btn" data-layout="4">4</button>
    </div>
  </div>
  
  <div class="controls">
    <div class="controls-row" id="custom-row" style="display:none;">
      <div class="main-customization" id="main-customization"></div>
    </div>
    <div class="controls-row">
      <div class="view-switcher" id="view-switcher">
        <button class="view-mode-btn active" id="view-space" data-mode="space">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="5" cy="6" r="1.5" fill="currentColor" stroke="none"/><circle cx="12" cy="4" r="1.5" fill="currentColor" stroke="none"/><circle cx="19" cy="7" r="1.5" fill="currentColor" stroke="none"/><circle cx="7" cy="14" r="1.5" fill="currentColor" stroke="none"/><circle cx="16" cy="13" r="1.5" fill="currentColor" stroke="none"/><circle cx="4" cy="20" r="1.5" fill="currentColor" stroke="none"/><circle cx="12" cy="19" r="1.5" fill="currentColor" stroke="none"/><circle cx="20" cy="18" r="1.5" fill="currentColor" stroke="none"/></svg>
          SPACE
        </button>
        <button class="view-mode-btn" id="view-sphere" data-mode="sphere">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="9"/><ellipse cx="12" cy="12" rx="9" ry="3.5"/><path d="M8.5 3.5C9 7 9 17 8.5 20.5" /><path d="M15.5 3.5C15 7 15 17 15.5 20.5" /></svg>
          SPHERE
        </button>
        <button class="view-mode-btn" id="view-stream" data-mode="stream">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="8" width="5" height="8" rx="1"/><rect x="9.5" y="8" width="5" height="8" rx="1"/><rect x="18" y="8" width="5" height="8" rx="1"/><line x1="1" y1="12" x2="23" y2="12" stroke-dasharray="1 2" opacity="0.4"/></svg>
          STREAM
        </button>
        <button class="view-mode-btn" id="view-focus" data-mode="focus">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="3"/><rect x="6.5" y="6.5" width="11" height="11" rx="1.5"/></svg>
          FOCUS
        </button>
        <button class="view-mode-btn" id="view-queue" data-mode="queue">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="6" width="18" height="12" rx="2"/><rect x="5" y="4" width="14" height="12" rx="2" opacity="0.5"/><rect x="7" y="2" width="10" height="12" rx="2" opacity="0.25"/></svg>
          QUEUE
        </button>
        <button class="view-mode-btn" id="view-grids" data-mode="grids">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
          GRIDS
        </button>
      </div>
      <button class="custom-toggle" id="custom-toggle">
        <div class="custom-icon"><span></span><span></span><span></span></div>
        CUSTOM
      </button>
    </div>
    <div class="controls-row">
      <div class="controls-help" id="controls-help">Drag to pan<span>·</span>Scroll to zoom<span>·</span>Click to view</div>
    </div>
  </div>
  
  <div class="zoom-indicator" id="zoom-indicator">0%</div>
  
  <script>
    const images = [
      'logo.png', 'art.jpeg', 'TRUST.png',
      '025ce04a-753c-4ac0-90fc-724966e35fa5.jpeg', '03cdbf2e8d84091b535378b6f3e28b7d.jpg',
      '04d800fd-d969-41e8-adf8-64ebf6eb37e1.jpeg', '16fab7bb-6495-4d45-b25d-494055a4b33c.jpeg',
      '2a3335cdc27bdc677f89863667c354dc.jpg', '34170add96db0159709f82efb83f7c39.jpg',
      '37e7433f65e6064acf64c1993810b0cf.jpg', '3df2bb29-8609-42d8-ac77-e68dbef4b475.jpeg',
      '57cbd7bdd778d87b337dc1120769decb.jpg', '6a8b2dc0-12fc-4ba3-aa31-aff359a761e8.jpeg',
      '6e89fb39-3096-4e92-9f32-e6101f6ff825.jpeg', '6f53ae36-505b-440f-affe-0cc0cf9e8529.jpeg',
      '71097654-382a-46ec-a3d4-2478ae087251.jpeg', '74d2981eb2e8400526272f86c55bc5d6.jpg',
      '965d8b1dcc482979f0329b574cfd1108.jpg', '9d4b466353bc2ec699b8062a163db00c.jpg',
      '9e297d9e1365fb44836fb54ea76fe408.jpg', 'a12121b22ebf2f3dce8adf5469439113.jpg',
      'acf8fea5-220f-445e-8785-2ddac7bf4640.jpeg', 'adfa35385556cdca00bcfb6014cf8e77.jpg',
      'b4a0ccf623676d6f3e889f1d4757ed4c.jpg', 'b54c9dba-2d38-4b15-b7b0-a2557faddfd5.jpeg',
      'b77a8587faa5df05f683aa53ffb395f5.jpg', 'c2edbde2-2f5b-49f5-9349-174472851ef5.jpeg',
      'c9d73c80-5b88-4cb9-95c5-8e126dceb88b.jpeg', 'd85e35fb-751b-4344-8bf3-e4851c8ddd43.jpeg',
      'e08063e1-19be-413f-9acc-10c3cced32f4.jpeg', 'e791c2d7cc6d7d583763189e0e8c4fc7.jpg',
      'e79b0b372fc86ae378931ecd65d4a9f6.jpg', 'e969743e-8178-498c-85b6-365b2a2080a5.jpeg',
      'ee8684761fe56f1891ac18dc859623c0.jpg', 'f0118967-4c43-4fd1-80a7-a4d855a14f2c.jpeg',
      'f6c59438-1a4a-47f2-a093-fe18e1bad0da.jpeg', 'fe29348e36a36c2c99edb58821330c79.jpg',
      'FJanx6YWYAo8KW9.jpeg', 'G__9DIUbcAAt_cy.jpeg', 'G__MaODbEAQ7Rn3.jpeg',
      'G_6ATQ2XoAA95dV.jpeg', 'G_758bdWwAATy_9.jpeg', 'G_Cw8iBW0AAcDiV.jpeg',
      'G_NWn8FaIAEO25I.jpeg', 'G_vet9yWcAARLKT.jpeg', 'G046ZVHWkAABcQ1.jpeg',
      'G06JwjsWQAAw4Y5.jpeg', 'G2naqcabIAEp8jE.jpeg', 'G36PhxlWcAAxPr5.jpeg',
      'G5BFNOzWYAAuMHi.jpeg', 'G8lehBTW8AA6C5u.jpeg', 'G93cWkQXcAAXPcr.jpeg',
      'GLnfiyfWQAItm-O.jpeg', 'Gz7G_5rXEAAc7mt.jpeg', 'GzHnXerWoAAp5lI.jpeg',
      'HAD4TeTbAAA7suu.jpeg', 'HAE4mByWMAAAzbd.jpeg', 'HAGeCV-XkAAVCu2.jpeg', 'HAOPIy1WAAA-j5X.jpeg'
    ].map(src => ({ src, label: 'artasas' }));

    class Gallery {
      constructor() {
        this.container = document.getElementById('gallery-container');
        this.canvas = document.getElementById('gallery-canvas');
        this.imageDetail = document.getElementById('image-detail');
        this.detailImage = document.getElementById('detail-image');
        this.colorSwatches = document.getElementById('color-swatches');
        this.saveBoardBtn = document.getElementById('save-board-btn');
        this.colorCanvas = document.getElementById('color-canvas');
        this.gridView = document.getElementById('grid-view');
        this.gridContent = document.getElementById('grid-content');
        this.gridToggle = document.getElementById('view-grids');
        this.zoomIndicator = document.getElementById('zoom-indicator');
        this.loading = document.getElementById('loading');
        this.controlsHelp = document.getElementById('controls-help');
        this.vortexCanvas = document.getElementById('vortex-lines');
        this.vortexCtx = this.vortexCanvas.getContext('2d');
        
        this.savedImages = new Set();
        this.currentImageIndex = 0;
        this.currentHome = 1;
        this.imageData = [];
        this.items = [];
        this.isGridView = false;
        this.viewMode = 'space';
        
        // Space mode state
        this.cameraZ = 0;
        this.targetCameraZ = 0;
        this.panX = 0;
        this.panY = 0;
        this.targetPanX = 0;
        this.targetPanY = 0;
        this.velX = 0;
        this.velY = 0;
        
        this.isDragging = false;
        this.dragStarted = false;
        this.lastX = 0;
        this.lastY = 0;
        
        this.friction = 0.92;
        this.ease = 0.08;
        this.zEase = 0.06;
        this.spaceWidth = 2000;
        this.spaceHeight = 1500;
        this.spaceDepth = 8000;
        this.minZ = -500;
        this.maxZ = this.spaceDepth + 500;
        this.fov = 800;
        this.baseSize = 220;
        this.spreadMultiplier = 1;
        
        // Sphere mode state — quaternion-based free rotation
        this.sqw = 1; this.sqx = 0; this.sqy = 0; this.sqz = 0;
        this.tqw = 1; this.tqx = 0; this.tqy = 0; this.tqz = 0;
        this.sphereVelX = 0;
        this.sphereVelY = 0;
        this.sphereRadius = 550;
        this.sphereCamDist = 1600;
        this.targetSphereCamDist = 1600;
        this.sphereFov = 900;
        this.sphereItemSize = 110;
        this.sphereAutoRotate = true;
        
        // Stream mode state — horizontal filmstrip
        this.streamOffset = 0;
        this.streamSpeed = 1.5;
        this.streamItemW = 280;
        this.streamGap = 24;
        this.streamMaxH = 360;
        this.streamDragVel = 0;
        this.streamHeld = false;
        this.streamHover = false;
        
        // Focus mode state — one image at a time
        this.focusIndex = 0;
        this.focusTarget = 0;
        this.focusProgress = 0;
        this.focusScrollAccum = 0;
        this.focusTransitionSpeed = 0.08;
        this.focusPaused = false;
        
        // Queue mode state — Z-axis file of images
        this.queueOffset = 0;
        this.queueTargetOffset = 0;
        this.queueSpacing = 320;
        this.queueFov = 800;
        this.queueAutoSpeed = 0.4;
        this.queuePaused = false;
        
        this.init();
      }
      
      async init() {
        await this.loadImages(images);
        this.createGalleryItems();
        this.createGridView();
        this.setupEvents();
        this.setupLayoutSwitcher();
        this.setupMainCustomization();
        this.setupHomeSwitcher();
        this.setupDragToBoard();
        this.setupViewSwitcher();
        this.setGridLayout('1');
        this.computeSpherePositions();
        this.vortexCanvas.style.display = 'block';
        this.animate();
        setTimeout(() => this.loading.classList.add('hidden'), 500);
        
        this.checkUrlParams();
      }
      
      checkUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const imageSrc = params.get('image');
        if (imageSrc) {
          const imgData = this.imageData.find(img => img.src === imageSrc);
          if (imgData) {
            setTimeout(() => this.openDetail(imgData), 600);
          }
          // Clean URL without reload
          window.history.replaceState({}, '', window.location.pathname);
        }
      }
      
      async loadImages(images) {
        this.imageData = await Promise.all(images.map(img => 
          new Promise(resolve => {
            const image = new Image();
            image.onload = () => resolve({ ...img, width: image.width, height: image.height });
            image.onerror = () => resolve({ ...img, width: 300, height: 200 });
            image.src = img.src;
          })
        ));
      }
      
      createGalleryItems() {
        this.canvas.innerHTML = '';
        this.items = [];
        const total = this.imageData.length;
        const boards = ['Inspiration', 'References', 'Favorites'];
        
        this.imageData.forEach((imgData, index) => {
          const item = document.createElement('div');
          item.className = 'gallery-item';
          
          const sizeVariation = Math.random();
          const baseSize = 180 + sizeVariation * 150;
          const ratio = imgData.width / imgData.height;
          const w = ratio > 1 ? baseSize : baseSize * ratio;
          const h = ratio > 1 ? baseSize / ratio : baseSize;
          
          item.style.width = `${w}px`;
          item.style.height = `${h}px`;
          
          const img = document.createElement('img');
          img.src = imgData.src;
          img.alt = imgData.label;
          img.draggable = false;
          item.appendChild(img);
          
          // Save button
          const saveBtn = document.createElement('button');
          saveBtn.className = 'gallery-save-btn';
          saveBtn.textContent = 'Save';
          saveBtn.addEventListener('click', (e) => e.stopPropagation());
          item.appendChild(saveBtn);
          
          // Dropdown
          const dropdown = document.createElement('div');
          dropdown.className = 'gallery-save-dropdown';
          boards.forEach(board => {
            const boardBtn = document.createElement('button');
            boardBtn.className = 'gallery-save-dropdown-item';
            boardBtn.textContent = board;
            boardBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              this.saveToGalleryBoard(imgData, board, saveBtn);
            });
            dropdown.appendChild(boardBtn);
          });
          saveBtn.appendChild(dropdown);
          
          item.addEventListener('click', (e) => {
            if (!this.dragStarted && !e.target.closest('.gallery-save-btn')) {
              this.openDetail(imgData);
            }
          });
          item.addEventListener('mouseenter', () => { this.streamHover = true; });
          item.addEventListener('mouseleave', () => { this.streamHover = false; });
          this.canvas.appendChild(item);
          
          const baseX = (Math.random() - 0.5) * this.spaceWidth;
          const baseY = (Math.random() - 0.5) * this.spaceHeight;
          
          this.items.push({ 
            el: item,
            x: baseX,
            y: baseY,
            baseX: baseX,
            baseY: baseY,
            z: (index / total) * this.spaceDepth + (Math.random() - 0.5) * 300,
            width: w,
            height: h,
            originalWidth: imgData.width,
            originalHeight: imgData.height,
            sizeVariation: sizeVariation
          });
        });
        
        this.items.sort((a, b) => b.z - a.z);
      }
      
      saveToGalleryBoard(imgData, board, btn) {
        btn.textContent = 'Saved';
        setTimeout(() => {
          btn.textContent = 'Save';
          const dropdown = document.createElement('div');
          dropdown.className = 'gallery-save-dropdown';
          ['Inspiration', 'References', 'Favorites'].forEach(b => {
            const boardBtn = document.createElement('button');
            boardBtn.className = 'gallery-save-dropdown-item';
            boardBtn.textContent = b;
            boardBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              this.saveToGalleryBoard(imgData, b, btn);
            });
            dropdown.appendChild(boardBtn);
          });
          btn.appendChild(dropdown);
        }, 1500);
      }
      
      createGridView() {
        this.gridContent.innerHTML = '';
        this.boards = ['Inspiration', 'References', 'Favorites'];
        
        this.imageData
          .filter(imgData => imgData.src !== 'logo.png')
          .forEach(imgData => {
            const item = document.createElement('div');
            item.className = 'grid-view-item';
            
            const img = document.createElement('img');
            img.src = imgData.src;
            img.alt = imgData.label;
            img.addEventListener('click', () => this.openDetail(imgData));
            item.appendChild(img);
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'grid-save-btn';
            saveBtn.textContent = 'Save';
            
            const dropdown = document.createElement('div');
            dropdown.className = 'save-dropdown';
            this.boards.forEach(board => {
              const boardBtn = document.createElement('button');
              boardBtn.className = 'save-dropdown-item';
              boardBtn.textContent = board;
              boardBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.saveToBoard(imgData, board, saveBtn);
              });
              dropdown.appendChild(boardBtn);
            });
            saveBtn.appendChild(dropdown);
            item.appendChild(saveBtn);
            
            this.gridContent.appendChild(item);
          });
      }
      
      saveToBoard(imgData, board, btn) {
        btn.textContent = 'Saved';
        setTimeout(() => {
          btn.textContent = 'Save';
          const dropdown = document.createElement('div');
          dropdown.className = 'save-dropdown';
          this.boards.forEach(b => {
            const boardBtn = document.createElement('button');
            boardBtn.className = 'save-dropdown-item';
            boardBtn.textContent = b;
            boardBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              this.saveToBoard(imgData, b, btn);
            });
            dropdown.appendChild(boardBtn);
          });
          btn.appendChild(dropdown);
        }, 1500);
      }
      
      setupEvents() {
        this.container.addEventListener('mousedown', e => this.onDown(e.clientX, e.clientY));
        window.addEventListener('mousemove', e => this.onMove(e.clientX, e.clientY));
        window.addEventListener('mouseup', () => this.onUp());
        
        this.container.addEventListener('touchstart', e => {
          if (e.touches.length === 1) this.onDown(e.touches[0].clientX, e.touches[0].clientY);
        }, { passive: false });
        
        window.addEventListener('touchmove', e => {
          if (e.touches.length === 1) {
            e.preventDefault();
            this.onMove(e.touches[0].clientX, e.touches[0].clientY);
          }
        }, { passive: false });
        
        window.addEventListener('touchend', () => this.onUp());
        
        this.container.addEventListener('wheel', e => {
          e.preventDefault();
          if (this.viewMode === 'sphere') {
            this.targetSphereCamDist = Math.max(-200, Math.min(3000, this.targetSphereCamDist + e.deltaY * 1.5));
          } else if (this.viewMode === 'stream') {
            this.streamSpeed = Math.max(-10, Math.min(10, this.streamSpeed - e.deltaY * 0.008));
          } else if (this.viewMode === 'focus') {
            this.focusPaused = false;
            this.focusScrollAccum += e.deltaY;
            const threshold = 80;
            if (this.focusScrollAccum > threshold) {
              this.focusTarget = Math.min(this.items.length - 1, this.focusTarget + 1);
              this.focusScrollAccum = 0;
            } else if (this.focusScrollAccum < -threshold) {
              this.focusTarget = Math.max(0, this.focusTarget - 1);
              this.focusScrollAccum = 0;
            }
          } else if (this.viewMode === 'queue') {
            this.queuePaused = false;
            this.queueAutoSpeed = Math.max(-8, Math.min(8, this.queueAutoSpeed + e.deltaY * 0.006));
          } else {
            this.targetCameraZ = Math.max(this.minZ, Math.min(this.maxZ, this.targetCameraZ + e.deltaY * 2));
          }
        }, { passive: false });
        
        document.getElementById('detail-close').addEventListener('click', () => this.closeDetail());
        document.getElementById('nav-prev').addEventListener('click', () => this.navigateImage(-1));
        document.getElementById('nav-next').addEventListener('click', () => this.navigateImage(1));
        this.saveBoardBtn.addEventListener('click', () => this.toggleSave());
        document.getElementById('grid-close').addEventListener('click', () => {
          document.getElementById('view-space').click();
        });
        
        // 3D tilt effect on detail image
        this.detailImage.addEventListener('mousemove', (e) => {
          if (!this.isDraggingToBoard) this.handleImageTilt(e);
        });
        this.detailImage.addEventListener('mouseleave', () => this.resetImageTilt());
        
        document.addEventListener('keydown', e => {
          if (e.key === 'Escape') {
            if (this.imageDetail.classList.contains('active')) this.closeDetail();
            else if (this.isGridView) document.getElementById('view-space').click();
          }
          if (this.imageDetail.classList.contains('active')) {
            if (e.key === 'ArrowLeft') this.navigateImage(-1);
            if (e.key === 'ArrowRight') this.navigateImage(1);
          }
        });
      }
      
      handleImageTilt(e) {
        const rect = this.detailImage.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        
        const rotateX = ((y - centerY) / centerY) * -18;
        const rotateY = ((x - centerX) / centerX) * 18;
        const shadowX = rotateY * 3;
        const shadowY = rotateX * -3;
        
        this.detailImage.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
        this.detailImage.style.boxShadow = `${shadowX}px ${40 + shadowY}px 120px rgba(0, 0, 0, 0.7)`;
      }
      
      resetImageTilt() {
        this.detailImage.style.transform = 'rotateX(0deg) rotateY(0deg) scale(1)';
        this.detailImage.style.boxShadow = '0 40px 120px rgba(0, 0, 0, 0.6)';
      }
      
      setupDragToBoard() {
        this.isDraggingToBoard = false;
        this.dragOverlay = document.getElementById('drag-boards-overlay');
        this.dragPreview = document.getElementById('drag-preview');
        this.dragBoardsContainer = document.getElementById('drag-boards-container');
        this.dragStartPos = { x: 0, y: 0 };
        
        this.detailImage.addEventListener('mousedown', (e) => this.startDragToBoard(e));
        document.addEventListener('mousemove', (e) => this.onDragToBoard(e));
        document.addEventListener('mouseup', (e) => this.endDragToBoard(e));
        
        this.createBoardTargets();
      }
      
      createBoardTargets() {
        const boardsData = [
          { name: 'Inspiration', count: 24 },
          { name: 'References', count: 18 },
          { name: 'Favorites', count: 42 },
          { name: '+ New Board', count: 0 }
        ];
        
        this.dragBoardsContainer.innerHTML = '';
        
        boardsData.forEach(board => {
          const target = document.createElement('div');
          target.className = 'drag-board-target';
          target.dataset.board = board.name.replace('+ ', '');
          target.innerHTML = `
            <div class="drag-board-name">${board.name}</div>
            ${board.count > 0 ? `<div class="drag-board-count">${board.count}</div>` : ''}
          `;
          target.addEventListener('mouseenter', () => target.classList.add('hover'));
          target.addEventListener('mouseleave', () => target.classList.remove('hover'));
          this.dragBoardsContainer.appendChild(target);
        });
      }
      
      startDragToBoard(e) {
        if (!this.imageDetail.classList.contains('active')) return;
        e.preventDefault();
        this.dragStartPos = { x: e.clientX, y: e.clientY };
        this.potentialDrag = true;
      }
      
      onDragToBoard(e) {
        if (!this.potentialDrag && !this.isDraggingToBoard) return;
        
        const dx = e.clientX - this.dragStartPos.x;
        const dy = e.clientY - this.dragStartPos.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (this.potentialDrag && distance > 20) {
          this.potentialDrag = false;
          this.isDraggingToBoard = true;
          this.detailImage.classList.add('dragging');
          this.dragOverlay.classList.add('active');
          this.resetImageTilt();
          
          this.dragPreview.src = this.currentImage.src;
          this.dragPreview.style.width = '120px';
          this.dragPreview.style.display = 'block';
        }
        
        if (this.isDraggingToBoard) {
          this.dragPreview.style.left = (e.clientX - 60) + 'px';
          this.dragPreview.style.top = (e.clientY - 60) + 'px';
        }
      }
      
      endDragToBoard(e) {
        this.potentialDrag = false;
        if (!this.isDraggingToBoard) return;
        
        const target = document.elementFromPoint(e.clientX, e.clientY);
        const boardTarget = target?.closest('.drag-board-target');
        
        if (boardTarget) {
          const boardName = boardTarget.dataset.board;
          boardTarget.classList.add('drop-success');
          setTimeout(() => {
            boardTarget.classList.remove('drop-success');
            this.closeDragOverlay();
            this.showSaveConfirmation(boardName);
          }, 300);
        } else {
          this.closeDragOverlay();
        }
      }
      
      closeDragOverlay() {
        this.isDraggingToBoard = false;
        this.detailImage.classList.remove('dragging');
        this.dragOverlay.classList.remove('active');
        this.dragPreview.style.display = 'none';
      }
      
      showSaveConfirmation(boardName) {
        const originalText = this.saveBoardBtn.innerHTML;
        this.saveBoardBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
          Saved to ${boardName}
        `;
        this.saveBoardBtn.style.borderColor = 'rgba(255, 255, 255, 0.4)';
        setTimeout(() => {
          this.saveBoardBtn.innerHTML = originalText;
          this.saveBoardBtn.style.borderColor = '';
        }, 2000);
      }
      
      computeSpherePositions() {
        const total = this.items.length;
        const goldenAngle = Math.PI * (3 - Math.sqrt(5));
        this.items.forEach((item, i) => {
          const y = 1 - (i / (total - 1)) * 2;
          const radiusAtY = Math.sqrt(1 - y * y);
          const theta = goldenAngle * i;
          item.sphereX = radiusAtY * Math.cos(theta);
          item.sphereY = y;
          item.sphereZ = radiusAtY * Math.sin(theta);
        });
      }
      
      // Quaternion helpers
      quatMultiply(aw, ax, ay, az, bw, bx, by, bz) {
        return [
          aw*bw - ax*bx - ay*by - az*bz,
          aw*bx + ax*bw + ay*bz - az*by,
          aw*by - ax*bz + ay*bw + az*bx,
          aw*bz + ax*by - ay*bx + az*bw
        ];
      }
      
      quatFromAxis(ax, ay, az, angle) {
        const half = angle / 2;
        const s = Math.sin(half);
        return [Math.cos(half), ax * s, ay * s, az * s];
      }
      
      quatRotateVec(qw, qx, qy, qz, vx, vy, vz) {
        const ix = qw*vx + qy*vz - qz*vy;
        const iy = qw*vy + qz*vx - qx*vz;
        const iz = qw*vz + qx*vy - qy*vx;
        const iw = -qx*vx - qy*vy - qz*vz;
        return [
          ix*qw + iw*(-qx) + iy*(-qz) - iz*(-qy),
          iy*qw + iw*(-qy) + iz*(-qx) - ix*(-qz),
          iz*qw + iw*(-qz) + ix*(-qy) - iy*(-qx)
        ];
      }
      
      quatNormalize(w, x, y, z) {
        const len = Math.sqrt(w*w + x*x + y*y + z*z);
        return [w/len, x/len, y/len, z/len];
      }
      
      quatSlerp(aw, ax, ay, az, bw, bx, by, bz, t) {
        let dot = aw*bw + ax*bx + ay*by + az*bz;
        if (dot < 0) { bw = -bw; bx = -bx; by = -by; bz = -bz; dot = -dot; }
        if (dot > 0.9995) {
          return this.quatNormalize(aw + t*(bw-aw), ax + t*(bx-ax), ay + t*(by-ay), az + t*(bz-az));
        }
        const theta0 = Math.acos(dot);
        const theta = theta0 * t;
        const sinTheta = Math.sin(theta);
        const sinTheta0 = Math.sin(theta0);
        const s0 = Math.cos(theta) - dot * sinTheta / sinTheta0;
        const s1 = sinTheta / sinTheta0;
        return this.quatNormalize(s0*aw + s1*bw, s0*ax + s1*bx, s0*ay + s1*by, s0*az + s1*bz);
      }
      
      applySphereRotation(dx, dy) {
        const angle = Math.sqrt(dx*dx + dy*dy);
        if (angle < 0.0001) return;
        const ax = -dy / angle;
        const ay = dx / angle;
        const [rw, rx, ry, rz] = this.quatFromAxis(ax, ay, 0, angle);
        [this.tqw, this.tqx, this.tqy, this.tqz] = this.quatMultiply(rw, rx, ry, rz, this.tqw, this.tqx, this.tqy, this.tqz);
        [this.tqw, this.tqx, this.tqy, this.tqz] = this.quatNormalize(this.tqw, this.tqx, this.tqy, this.tqz);
      }
      
      setupViewSwitcher() {
        const btns = document.querySelectorAll('.view-mode-btn');
        btns.forEach(btn => {
          btn.addEventListener('click', () => {
            const mode = btn.dataset.mode;
            if (mode === this.viewMode) return;
            
            if (this.isGridView) {
              this.isGridView = false;
              this.gridView.classList.remove('active');
              document.getElementById('grid-close').classList.remove('active');
              document.getElementById('grid-customization').classList.remove('active');
              document.body.style.cursor = 'grab';
            }
            
            this.viewMode = mode;
            btns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            if (mode === 'grids') {
              this.isGridView = true;
              this.gridView.classList.add('active');
              document.getElementById('grid-close').classList.add('active');
              document.getElementById('grid-customization').classList.add('active');
              this.controlsHelp.innerHTML = 'Click to view<span>·</span>Customize layout above';
              this.vortexCanvas.style.display = 'none';
              document.body.style.cursor = 'default';
              document.getElementById('custom-toggle').style.display = 'none';
              document.getElementById('custom-row').style.display = 'none';
            } else if (mode === 'sphere') {
              document.getElementById('custom-toggle').style.display = 'flex';
              this.controlsHelp.innerHTML = 'Drag to rotate<span>·</span>Scroll to zoom<span>·</span>Click to view';
              this.sphereVelX = 0;
              this.sphereVelY = 0;
              this.sphereAutoRotate = true;
              this.vortexCanvas.style.display = 'block';
            } else if (mode === 'stream') {
              document.getElementById('custom-toggle').style.display = 'flex';
              this.controlsHelp.innerHTML = 'Drag to scrub<span>·</span>Scroll to change speed<span>·</span>Click to view';
              this.vortexCanvas.style.display = 'block';
              this.streamSpeed = 1.5;
              this.items.forEach(item => { item.el.style.transform = ''; });
            } else if (mode === 'focus') {
              document.getElementById('custom-toggle').style.display = 'flex';
              this.controlsHelp.innerHTML = 'Scroll to browse<span>·</span>Click to view details';
              this.vortexCanvas.style.display = 'block';
              this.focusIndex = 0;
              this.focusTarget = 0;
              this.focusProgress = 0;
              this.focusScrollAccum = 0;
              this.items.forEach(item => { item.el.style.transform = ''; });
            } else if (mode === 'queue') {
              document.getElementById('custom-toggle').style.display = 'flex';
              this.controlsHelp.innerHTML = 'Scroll to change speed<span>·</span>Drag to advance<span>·</span>Click to view';
              this.vortexCanvas.style.display = 'block';
              this.queueOffset = 0;
              this.queueTargetOffset = 0;
              this.queueAutoSpeed = 0.4;
              this.items.forEach(item => { item.el.style.transform = ''; });
            } else {
              document.getElementById('custom-toggle').style.display = 'flex';
              this.controlsHelp.innerHTML = 'Drag to pan<span>·</span>Scroll to zoom<span>·</span>Click to view';
              this.items.forEach(item => { item.el.style.transform = ''; });
              this.vortexCanvas.style.display = 'block';
            }
            this.buildCustomPanel();
          });
        });
      }
      
      onDown(px, py) {
        this.isDragging = true;
        this.dragStarted = false;
        this.startDragX = px;
        this.startDragY = py;
        this.lastX = px;
        this.lastY = py;
        this.velX = 0;
        this.velY = 0;
        this.sphereVelX = 0;
        this.sphereVelY = 0;
        if (this.viewMode === 'stream') {
          this.streamHeld = true;
          this.streamDragVel = 0;
        }
        document.body.style.cursor = 'grabbing';
      }
      
      onMove(px, py) {
        if (!this.isDragging) return;
        const dx = px - this.lastX;
        const dy = py - this.lastY;
        if (Math.abs(px - this.startDragX) > 5 || Math.abs(py - this.startDragY) > 5) this.dragStarted = true;
        
        if (this.viewMode === 'sphere') {
          const sensitivity = 0.006;
          this.sphereVelX = dx * sensitivity;
          this.sphereVelY = dy * sensitivity;
          this.applySphereRotation(dx * sensitivity, dy * sensitivity);
        } else if (this.viewMode === 'stream') {
          this.streamDragVel = -dx * 3.5;
          this.streamOffset += this.streamDragVel;
        } else if (this.viewMode === 'focus') {
          this.focusPaused = true;
        } else if (this.viewMode === 'queue') {
          this.queuePaused = true;
        } else {
          this.velX = dx * 0.7;
          this.velY = dy * 0.7;
          this.targetPanX += dx * 1.5;
          this.targetPanY += dy * 1.5;
        }
        
        this.lastX = px;
        this.lastY = py;
      }
      
      onUp() {
        this.isDragging = false;
        if (this.viewMode === 'stream') {
          this.streamHeld = false;
        }
        document.body.style.cursor = 'grab';
      }
      
      animate() {
        if (this.viewMode === 'sphere') {
          this.animateSphere();
        } else if (this.viewMode === 'stream') {
          this.animateStream();
        } else if (this.viewMode === 'focus') {
          this.animateFocus();
        } else if (this.viewMode === 'queue') {
          this.animateQueue();
        } else {
          this.animateSpace();
        }
        requestAnimationFrame(() => this.animate());
      }
      
      animateSpace() {
        if (!this.isDragging) {
          this.targetPanX += this.velX;
          this.targetPanY += this.velY;
          this.velX *= this.friction;
          this.velY *= this.friction;
        }
        
        this.panX += (this.targetPanX - this.panX) * this.ease;
        this.panY += (this.targetPanY - this.panY) * this.ease;
        this.cameraZ += (this.targetCameraZ - this.cameraZ) * this.zEase;
        
        const W = window.innerWidth;
        const H = window.innerHeight;
        const cx = W / 2;
        const cy = H / 2;
        
        const cvs = this.vortexCanvas;
        cvs.width = W;
        cvs.height = H;
        const ctx = this.vortexCtx;
        ctx.clearRect(0, 0, W, H);
        
        this.items.forEach(item => {
          const relativeZ = item.z - this.cameraZ;
          
          if (relativeZ < 10) {
            item.el.style.display = 'none';
            return;
          }
          
          item.el.style.display = 'block';
          const scale = this.fov / relativeZ;
          const screenX = cx + (item.x + this.panX * 0.8) * scale;
          const screenY = cy + (item.y + this.panY * 0.8) * scale;
          const w = item.width * scale;
          const h = item.height * scale;
          
          let opacity = 1;
          if (relativeZ < 100) opacity = relativeZ / 100;
          else if (relativeZ > 3000) opacity = Math.max(0.2, 1 - (relativeZ - 3000) / 2000);
          
          item.el.style.left = `${screenX - w/2}px`;
          item.el.style.top = `${screenY - h/2}px`;
          item.el.style.width = `${w}px`;
          item.el.style.height = `${h}px`;
          item.el.style.opacity = opacity;
          item.el.style.zIndex = Math.round(10000 - relativeZ);
          item.el.style.filter = relativeZ > 2000 ? `blur(${Math.min(3, (relativeZ - 2000) / 1000)}px)` : 'none';
          item.el.style.borderRadius = '6px';
        });
        
        this.zoomIndicator.textContent = `${Math.round((this.cameraZ / this.spaceDepth) * 100)}%`;
      }
      
      animateSphere() {
        // Inertia when not dragging
        if (!this.isDragging) {
          if (Math.abs(this.sphereVelX) > 0.0001 || Math.abs(this.sphereVelY) > 0.0001) {
            this.applySphereRotation(this.sphereVelX, this.sphereVelY);
            this.sphereVelX *= 0.96;
            this.sphereVelY *= 0.96;
          } else if (this.sphereAutoRotate && this.sphereCamDist > 1000) {
            this.applySphereRotation(0.0012, 0.0003);
          }
        }
        
        // Smooth interpolation of quaternion
        [this.sqw, this.sqx, this.sqy, this.sqz] = this.quatSlerp(
          this.sqw, this.sqx, this.sqy, this.sqz,
          this.tqw, this.tqx, this.tqy, this.tqz,
          0.12
        );
        
        this.sphereCamDist += (this.targetSphereCamDist - this.sphereCamDist) * 0.08;
        
        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;
        const R = this.sphereRadius;
        const size = this.sphereItemSize;
        const camDist = this.sphereCamDist;
        
        this.items.forEach(item => {
          const [rx, ry, rz] = this.quatRotateVec(
            this.sqw, this.sqx, this.sqy, this.sqz,
            item.sphereX * R, item.sphereY * R, item.sphereZ * R
          );
          
          const perspZ = rz + camDist;
          
          if (perspZ < 80) {
            item.el.style.display = 'none';
            return;
          }
          
          item.el.style.display = 'block';
          const scale = this.sphereFov / perspZ;
          const screenX = cx + rx * scale;
          const screenY = cy + ry * scale;
          const w = size * scale;
          const h = size * scale;
          
          const [nx, ny, nz] = this.quatRotateVec(
            this.sqw, this.sqx, this.sqy, this.sqz,
            item.sphereX, item.sphereY, item.sphereZ
          );
          
          const normalizedZ = nz;
          const opacity = normalizedZ < -0.6 ? 0 : Math.max(0.08, 0.4 + normalizedZ * 0.6);
          
          if (opacity <= 0.01) {
            item.el.style.display = 'none';
            return;
          }
          
          const tiltY = Math.atan2(nx, nz) * (180 / Math.PI);
          const tiltX = Math.atan2(-ny, Math.sqrt(nx*nx + nz*nz)) * (180 / Math.PI);
          
          item.el.style.left = `${screenX - w/2}px`;
          item.el.style.top = `${screenY - h/2}px`;
          item.el.style.width = `${w}px`;
          item.el.style.height = `${h}px`;
          item.el.style.opacity = opacity;
          item.el.style.zIndex = Math.round(10000 + rz);
          item.el.style.filter = normalizedZ < -0.2 ? `blur(${Math.min(2, (-normalizedZ - 0.2) * 3)}px)` : 'none';
          item.el.style.borderRadius = '4px';
          item.el.style.transform = `perspective(800px) rotateY(${tiltY * 0.4}deg) rotateX(${tiltX * 0.4}deg)`;
        });
        
        const zoomPct = Math.round((1600 / this.sphereCamDist) * 100);
        this.zoomIndicator.textContent = `${zoomPct}%`;
      }
      
      animateStream() {
        const W = window.innerWidth;
        const H = window.innerHeight;
        const maxH = Math.min(this.streamMaxH, H * 0.85);
        const gap = this.streamGap;
        
        let totalLen = 0;
        const positions = this.items.map(item => {
          const ratio = (item.originalWidth || 300) / (item.originalHeight || 200);
          const h = maxH;
          const w = h * ratio;
          const start = totalLen;
          totalLen += w + gap;
          return { w, h, start };
        });
        
        if (this.streamHeld && !this.isDragging) {
          this.streamHeld = false;
        }
        
        const paused = this.streamHeld || (this.streamHover && !this.isDragging);
        
        if (paused) {
          this.streamDragVel *= 0.96;
        } else {
          this.streamDragVel *= 0.985;
          this.streamOffset += this.streamDragVel;
          this.streamOffset += this.streamSpeed;
        }
        
        if (totalLen > 0) {
          this.streamOffset = ((this.streamOffset % totalLen) + totalLen) % totalLen;
        }
        
        const cy = H / 2;
        
        const cvs = this.vortexCanvas;
        cvs.width = W;
        cvs.height = H;
        const ctx = this.vortexCtx;
        ctx.clearRect(0, 0, W, H);
        
        ctx.beginPath();
        ctx.moveTo(0, cy);
        ctx.lineTo(W, cy);
        ctx.strokeStyle = 'rgba(255,255,255,0.04)';
        ctx.lineWidth = 1;
        ctx.stroke();
        
        this.items.forEach((item, i) => {
          const p = positions[i];
          let x = p.start - this.streamOffset;
          
          x = ((x % totalLen) + totalLen) % totalLen;
          if (x > totalLen - p.w) x -= totalLen;
          
          const centerX = x + p.w / 2;
          const distFromCenter = Math.abs(centerX - W / 2);
          const maxDist = W / 2 + p.w;
          const normDist = Math.min(1, distFromCenter / maxDist);
          
          const opacity = Math.max(0.08, 1 - normDist * normDist);
          const scale = 0.85 + 0.15 * (1 - normDist);
          const blur = normDist > 0.7 ? (normDist - 0.7) * 6 : 0;
          
          if (x > -p.w - 100 && x < W + 100) {
            item.el.style.display = 'block';
            item.el.style.left = `${x}px`;
            item.el.style.top = `${cy - p.h / 2}px`;
            item.el.style.width = `${p.w}px`;
            item.el.style.height = `${p.h}px`;
            item.el.style.opacity = opacity;
            item.el.style.zIndex = Math.round(1000 - normDist * 100);
            item.el.style.filter = blur > 0 ? `blur(${blur.toFixed(1)}px)` : 'none';
            item.el.style.borderRadius = '6px';
            item.el.style.transform = `scale(${scale.toFixed(3)})`;
          } else {
            item.el.style.display = 'none';
          }
        });
        
        const absSpeed = Math.abs(this.streamSpeed);
        const dir = this.streamSpeed >= 0 ? '→' : '←';
        this.zoomIndicator.textContent = `${dir} ${absSpeed.toFixed(1)}x`;
      }
      
      animateFocus() {
        const W = window.innerWidth;
        const H = window.innerHeight;
        const cx = W / 2;
        const cy = H / 2;
        const total = this.items.length;
        
        if (!this.focusPaused) {
          this.focusProgress += (this.focusTarget - this.focusProgress) * this.focusTransitionSpeed;
        }
        
        const cvs = this.vortexCanvas;
        cvs.width = W;
        cvs.height = H;
        const ctx = this.vortexCtx;
        ctx.clearRect(0, 0, W, H);
        
        const maxImgH = Math.min(H * 0.7, 600);
        
        this.items.forEach((item, i) => {
          const diff = i - this.focusProgress;
          const absDiff = Math.abs(diff);
          
          if (absDiff > 2.5) {
            item.el.style.display = 'none';
            return;
          }
          
          const ratio = (item.originalWidth || 300) / (item.originalHeight || 200);
          const imgH = maxImgH;
          const imgW = imgH * ratio;
          
          const offsetY = diff * (H * 0.85);
          const scale = Math.max(0.4, 1 - absDiff * 0.35);
          const opacity = Math.max(0, 1 - absDiff * 0.7);
          const blur = absDiff > 0.5 ? Math.min(8, (absDiff - 0.5) * 8) : 0;
          
          const x = cx - (imgW * scale) / 2;
          const y = cy - (imgH * scale) / 2 + offsetY;
          
          item.el.style.display = 'block';
          item.el.style.left = `${x}px`;
          item.el.style.top = `${y}px`;
          item.el.style.width = `${imgW * scale}px`;
          item.el.style.height = `${imgH * scale}px`;
          item.el.style.opacity = opacity;
          item.el.style.zIndex = Math.round(1000 - absDiff * 100);
          item.el.style.filter = blur > 0 ? `blur(${blur.toFixed(1)}px)` : 'none';
          item.el.style.borderRadius = '8px';
          item.el.style.transform = `scale(1)`;
        });
        
        const current = Math.round(this.focusProgress);
        this.zoomIndicator.textContent = `${Math.min(current + 1, total)} / ${total}`;
        
        ctx.fillStyle = 'rgba(255, 255, 255, 0.08)';
        const barW = 3;
        const barH = Math.min(H * 0.3, 200);
        const barX = W - 24;
        const barY = cy - barH / 2;
        ctx.fillRect(barX, barY, barW, barH);
        
        const thumbH = Math.max(12, barH / total);
        const thumbY = barY + (this.focusProgress / Math.max(1, total - 1)) * (barH - thumbH);
        ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.fillRect(barX, thumbY, barW, thumbH);
      }
      
      animateQueue() {
        const W = window.innerWidth;
        const H = window.innerHeight;
        const cx = W / 2;
        const cy = H / 2;
        const total = this.items.length;
        const spacing = this.queueSpacing;
        const fov = this.queueFov;
        const totalDepth = total * spacing;
        
        if (!this.queuePaused) {
          this.queueTargetOffset += this.queueAutoSpeed;
          this.queueOffset += (this.queueTargetOffset - this.queueOffset) * 0.06;
        } else {
          this.queueTargetOffset = this.queueOffset;
        }
        
        const cvs = this.vortexCanvas;
        cvs.width = W;
        cvs.height = H;
        const ctx = this.vortexCtx;
        ctx.clearRect(0, 0, W, H);
        
        const vanishX = cx;
        const vanishY = cy * 0.9;
        for (let l = 0; l < 4; l++) {
          const angle = (l / 4) * Math.PI * 2 + Math.PI / 4;
          const nearR = 300;
          const farR = 5;
          ctx.beginPath();
          ctx.moveTo(vanishX + Math.cos(angle) * nearR, vanishY + Math.sin(angle) * nearR * 0.4);
          ctx.lineTo(vanishX + Math.cos(angle) * farR, vanishY + Math.sin(angle) * farR * 0.4);
          ctx.strokeStyle = 'rgba(255, 255, 255, 0.03)';
          ctx.lineWidth = 0.5;
          ctx.stroke();
        }
        
        const sorted = this.items.map((item, i) => {
          let z = i * spacing - this.queueOffset;
          z = ((z % totalDepth) + totalDepth) % totalDepth;
          if (z > totalDepth * 0.5) z -= totalDepth;
          return { item, i, z };
        }).filter(e => e.z > -spacing * 0.5 && e.z < totalDepth * 0.6)
          .sort((a, b) => b.z - a.z);
        
        const visibleSet = new Set(sorted.map(e => e.i));
        this.items.forEach((item, i) => {
          if (!visibleSet.has(i)) item.el.style.display = 'none';
        });
        
        sorted.forEach(({ item, z }) => {
          const perspZ = Math.max(50, z + spacing);
          const scale = fov / perspZ;
          
          const ratio = (item.originalWidth || 300) / (item.originalHeight || 200);
          const baseH = 200;
          const baseW = baseH * ratio;
          const w = baseW * scale;
          const h = baseH * scale;
          
          const screenX = cx - w / 2;
          const screenY = cy - h / 2 - (scale - 1) * 20;
          
          const normZ = Math.max(0, z) / (totalDepth * 0.5);
          const opacity = z < 0 ? Math.max(0, 1 + z / spacing) : Math.max(0.03, 1 - normZ * normZ);
          const blur = normZ > 0.4 ? Math.min(6, (normZ - 0.4) * 10) : 0;
          
          const tiltX = normZ * 12;
          
          item.el.style.display = 'block';
          item.el.style.left = `${screenX}px`;
          item.el.style.top = `${screenY}px`;
          item.el.style.width = `${w}px`;
          item.el.style.height = `${h}px`;
          item.el.style.opacity = opacity;
          item.el.style.zIndex = Math.round(10000 - z);
          item.el.style.filter = blur > 0 ? `blur(${blur.toFixed(1)}px)` : 'none';
          item.el.style.borderRadius = '6px';
          item.el.style.transform = `perspective(800px) rotateX(${tiltX}deg)`;
        });
        
        const speed = Math.abs(this.queueAutoSpeed);
        const dir = this.queueAutoSpeed >= 0 ? '▶' : '◀';
        this.zoomIndicator.textContent = `${dir} ${speed.toFixed(1)}x`;
      }
      
      openDetail(imgData) {
        this.currentImage = imgData;
        this.currentImageIndex = this.imageData.findIndex(img => img.src === imgData.src);
        this.updateDetailView(imgData);
        this.imageDetail.classList.add('active');
        document.body.style.cursor = 'default';
      }
      
      updateDetailView(imgData) {
        this.detailImage.src = imgData.src;
        document.getElementById('image-counter').textContent = `${this.currentImageIndex + 1} / ${this.imageData.length}`;
        
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => this.extractColors(img);
        img.src = imgData.src;
        
        this.currentImage = imgData;
        this.updateSaveButton(this.savedImages.has(imgData.src));
      }
      
      navigateImage(dir) {
        let idx = this.currentImageIndex + dir;
        if (idx < 0) idx = this.imageData.length - 1;
        if (idx >= this.imageData.length) idx = 0;
        this.currentImageIndex = idx;
        this.updateDetailView(this.imageData[idx]);
      }
      
      extractColors(img) {
        const ctx = this.colorCanvas.getContext('2d');
        const size = 80;
        this.colorCanvas.width = size;
        this.colorCanvas.height = size;
        ctx.drawImage(img, 0, 0, size, size);
        const data = ctx.getImageData(0, 0, size, size).data;
        
        const colorMap = {};
        for (let i = 0; i < data.length; i += 4) {
          const r = data[i], g = data[i + 1], b = data[i + 2];
          const brightness = (r + g + b) / 3;
          if (brightness < 20 || brightness > 240) continue;
          
          const key = `${Math.round(r / 32) * 32},${Math.round(g / 32) * 32},${Math.round(b / 32) * 32}`;
          if (!colorMap[key]) colorMap[key] = { count: 0, r: 0, g: 0, b: 0 };
          colorMap[key].count++;
          colorMap[key].r += r;
          colorMap[key].g += g;
          colorMap[key].b += b;
        }
        
        const sorted = Object.values(colorMap)
          .map(c => ({ r: Math.round(c.r / c.count), g: Math.round(c.g / c.count), b: Math.round(c.b / c.count), count: c.count }))
          .sort((a, b) => b.count - a.count);
        
        const distinct = [];
        for (const color of sorted) {
          const isDup = distinct.some(c => Math.abs(c.r - color.r) < 50 && Math.abs(c.g - color.g) < 50 && Math.abs(c.b - color.b) < 50);
          if (!isDup && distinct.length < 5) distinct.push(color);
        }
        
        this.displayColors(distinct);
      }
      
      displayColors(colors) {
        this.colorSwatches.innerHTML = '';
        colors.forEach(color => {
          const hex = '#' + [color.r, color.g, color.b].map(x => x.toString(16).padStart(2, '0')).join('').toUpperCase();
          const swatch = document.createElement('div');
          swatch.className = 'color-swatch';
          swatch.style.background = `rgb(${color.r}, ${color.g}, ${color.b})`;
          swatch.innerHTML = `<span class="color-hex">${hex}</span>`;
          swatch.addEventListener('click', () => {
            navigator.clipboard.writeText(hex);
            const hexEl = swatch.querySelector('.color-hex');
            hexEl.textContent = 'copied';
            hexEl.classList.add('copied');
            setTimeout(() => {
              hexEl.textContent = hex;
              hexEl.classList.remove('copied');
            }, 1200);
          });
          this.colorSwatches.appendChild(swatch);
        });
      }
      
      toggleSave() {
        if (!this.currentImage) return;
        const isSaved = this.savedImages.has(this.currentImage.src);
        isSaved ? this.savedImages.delete(this.currentImage.src) : this.savedImages.add(this.currentImage.src);
        this.updateSaveButton(!isSaved);
      }
      
      updateSaveButton(isSaved) {
        this.saveBoardBtn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="${isSaved ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
          </svg>
          ${isSaved ? 'Saved' : 'Save to Board'}
        `;
        this.saveBoardBtn.classList.toggle('saved', isSaved);
      }
      
      closeDetail() {
        this.imageDetail.classList.remove('active');
        document.body.style.cursor = 'grab';
      }
      
      toggleGrid() {
        this.isGridView = !this.isGridView;
        this.gridView.classList.toggle('active', this.isGridView);
        this.gridToggle.classList.toggle('active', this.isGridView);
        document.getElementById('grid-close').classList.toggle('active', this.isGridView);
        document.getElementById('grid-customization').classList.toggle('active', this.isGridView);
        document.getElementById('custom-toggle').style.display = this.isGridView ? 'none' : 'flex';
        if (this.isGridView) document.getElementById('custom-row').style.display = 'none';
        document.body.style.cursor = this.isGridView ? 'default' : 'grab';
      }
      
      setupLayoutSwitcher() {
        const buttons = document.querySelectorAll('.layout-btn');
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            const layout = btn.dataset.layout;
            this.setGridLayout(layout);
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
          });
        });
        
        document.getElementById('gap-slider').addEventListener('input', (e) => {
          this.gridContent.style.gap = e.target.value + 'px';
        });
        
        document.getElementById('size-slider').addEventListener('input', (e) => {
          this.gridContent.style.gridTemplateColumns = `repeat(auto-fill, minmax(${e.target.value}px, 1fr))`;
        });
      }
      
      setGridLayout(layout) {
        this.gridContent.className = 'grid-view-content layout-' + layout;
        this.gridContent.style.gap = '';
        this.gridContent.style.gridTemplateColumns = '';
        document.getElementById('gap-slider').value = 12;
        document.getElementById('size-slider').value = 220;
      }
      
      setupMainCustomization() {
        const toggleBtn = document.getElementById('custom-toggle');
        const customRow = document.getElementById('custom-row');
        this.customOpen = false;
        toggleBtn.addEventListener('click', () => {
          this.customOpen = !this.customOpen;
          customRow.style.display = this.customOpen ? 'flex' : 'none';
          toggleBtn.classList.toggle('active', this.customOpen);
        });
        this.buildCustomPanel();
      }
      
      buildCustomPanel() {
        const panel = document.getElementById('main-customization');
        panel.innerHTML = '';
        
        const sliders = [];
        
        if (this.viewMode === 'space') {
          sliders.push(
            { label: 'Size', min: 100, max: 400, value: this.baseSize || 220, handler: (v) => { this.baseSize = v; this.updateItemSizes(); }},
            { label: 'Spread', min: 500, max: 3000, value: Math.round((this.spreadMultiplier || 1) * 2000), handler: (v) => { this.spreadMultiplier = v / 2000; this.updateItemPositions(); }}
          );
        } else if (this.viewMode === 'sphere') {
          sliders.push(
            { label: 'Size', min: 50, max: 200, value: this.sphereItemSize, handler: (v) => { this.sphereItemSize = v; }},
            { label: 'Radius', min: 200, max: 1000, value: this.sphereRadius, handler: (v) => { this.sphereRadius = v; this.computeSpherePositions(); }}
          );
        } else if (this.viewMode === 'stream') {
          sliders.push(
            { label: 'Height', min: 120, max: 500, value: this.streamMaxH || 360, handler: (v) => { this.streamMaxH = v; }},
            { label: 'Speed', min: 0, max: 100, value: Math.round(this.streamSpeed * 10), handler: (v) => { this.streamSpeed = v / 10; }},
            { label: 'Gap', min: 4, max: 80, value: this.streamGap, handler: (v) => { this.streamGap = v; }}
          );
        } else if (this.viewMode === 'focus') {
          sliders.push(
            { label: 'Transition', min: 2, max: 15, value: Math.round(this.focusTransitionSpeed * 100), handler: (v) => { this.focusTransitionSpeed = v / 100; }}
          );
        } else if (this.viewMode === 'queue') {
          sliders.push(
            { label: 'Speed', min: 0, max: 80, value: Math.round(this.queueAutoSpeed * 10), handler: (v) => { this.queueAutoSpeed = v / 10; }},
            { label: 'Spacing', min: 100, max: 600, value: this.queueSpacing, handler: (v) => { this.queueSpacing = v; }}
          );
        }
        
        sliders.forEach((s, i) => {
          if (i > 0) {
            const divider = document.createElement('div');
            divider.className = 'custom-divider';
            panel.appendChild(divider);
          }
          const group = document.createElement('div');
          group.className = 'custom-group';
          group.innerHTML = `<span class="custom-label">${s.label}</span><input type="range" class="custom-slider" min="${s.min}" max="${s.max}" value="${s.value}">`;
          group.querySelector('input').addEventListener('input', (e) => s.handler(parseInt(e.target.value)));
          panel.appendChild(group);
        });
      }
      
      updateItemSizes() {
        this.items.forEach(item => {
          const ratio = item.originalWidth / item.originalHeight;
          const baseSize = this.baseSize + (item.sizeVariation * 150);
          item.width = ratio > 1 ? baseSize : baseSize * ratio;
          item.height = ratio > 1 ? baseSize / ratio : baseSize;
        });
      }
      
      updateItemPositions() {
        this.items.forEach(item => {
          item.x = item.baseX * this.spreadMultiplier;
          item.y = item.baseY * this.spreadMultiplier;
        });
      }
      
      setupHomeSwitcher() {
        const buttons = document.querySelectorAll('.home-btn');
        buttons.forEach(btn => {
          btn.addEventListener('click', async () => {
            const home = parseInt(btn.dataset.home);
            if (home === this.currentHome) return;
            
            this.currentHome = home;
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            this.loading.classList.remove('hidden');
            
            const images = home === 1 ? home1Images : home2Images;
            await this.loadImages(images);
            this.createGalleryItems();
            this.computeSpherePositions();
            this.createGridView();
            
            // Reset camera
            this.cameraZ = 0;
            this.targetCameraZ = 0;
            this.panX = 0;
            this.panY = 0;
            this.targetPanX = 0;
            this.targetPanY = 0;
            
            setTimeout(() => this.loading.classList.add('hidden'), 300);
          });
        });
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => new Gallery());
  </script>
</body>
</html>
